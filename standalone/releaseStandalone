#! /bin/bash
set -e
set -o pipefail
cd "$(dirname "${BASH_SOURCE[0]}")"

echo 'This script is for creating a standalone version of the AWS CloudFormation template generated by this CDK app. Unless you are the project maintainer you probably dont need this.'

ver="$(node -p "require('../package.json').version")"
s3bucket="s3.yo1.dog"
s3key="cloudformation/yo1ddns/v$ver"

echo "Creating relase v$ver"

dir="./out/v$ver"
rm -rf "$dir"
mkdir -p "$dir"

# create template
outfilename="$dir/yo1ddns.template.json"
node ./createStandalone.js "$ver" "$s3bucket" "$s3key"> "$outfilename"

# verify tempalte
aws cloudformation validate-template --template-body "file://$outfilename"

# upload tempalte
aws s3 cp "$outfilename" "s3://$s3bucket/$s3key/"

# process lambdas
for fndir in ../src/functions/*/; do
  fndir=${fndir%*/}
  zipfilename="$dir/${fndir##*/}.zip"
  
  # zip lambda
  (cd "$fndir"; zip - -r .) > "$zipfilename";
  
  # upload lambda
  aws s3 cp "$zipfilename" "s3://$s3bucket/$s3key/"
done